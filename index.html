<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audio Visualizer to GIF</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #1e1e1e, #121212);
      color: white;
      font-family: 'Arial', sans-serif;
    }
    canvas {
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
      margin-top: 20px;
      background: transparent;
    }
    button {
      padding: 12px 24px;
      margin-top: 20px;
      background-color: #6200ea;
      border: none;
      border-radius: 30px;
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #3700b3;
    }
  </style>
</head>
<body>

  <h1>오디오 비주얼라이저 GIF 생성기</h1>
  <input type="file" id="audioFile" accept="audio/*">
  <button id="startBtn">GIF 생성</button>
  <canvas id="visualizer" width="600" height="200"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/gif.js.optimized/dist/gif.js"></script>
  <script>
    const audioInput = document.getElementById('audioFile');
    const canvas = document.getElementById('visualizer');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');

    let audioBuffer, audioContext, sourceNode, analyser, dataArray;
    let audioFileName = "";

    audioInput.addEventListener('change', async () => {
      const file = audioInput.files[0];
      if (!file) return;
      audioFileName = file.name.replace(/\.[^/.]+$/, "");

      const arrayBuffer = await file.arrayBuffer();
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

      if (sourceNode) sourceNode.disconnect();
      sourceNode = audioContext.createBufferSource();
      sourceNode.buffer = audioBuffer;

      analyser = audioContext.createAnalyser();
      analyser.fftSize = 256;
      const bufferLength = analyser.frequencyBinCount;
      dataArray = new Uint8Array(bufferLength);

      sourceNode.connect(analyser);
      analyser.connect(audioContext.destination);
    });

    function drawVisualizer() {
      analyser.getByteFrequencyData(dataArray);

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const barWidth = canvas.width / dataArray.length;
      for (let i = 0; i < dataArray.length; i++) {
        const barHeight = dataArray[i];
        const x = i * barWidth + barWidth / 2;
        const y = canvas.height - barHeight / 2;
        const radius = barWidth / 2;

        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(255, 255, 255, 0.8)`;
        ctx.fill();
      }
    }

    startBtn.addEventListener('click', () => {
      if (!audioBuffer) return alert('오디오 파일을 먼저 선택하세요!');

      if (sourceNode) sourceNode.disconnect();
      sourceNode = audioContext.createBufferSource();
      sourceNode.buffer = audioBuffer;
      sourceNode.connect(analyser);
      analyser.connect(audioContext.destination);
      sourceNode.start();

      const gif = new GIF({
        workers: 2,
        quality: 10,
        width: canvas.width,
        height: canvas.height,
        workerScript: './gif.worker.js', // ← 여기만 수정
        transparent: null
      });

      const duration = audioBuffer.duration;
      const fps = 20;
      let frame = 0;
      const totalFrames = Math.floor(duration * fps);

      function captureFrame() {
        drawVisualizer();
        try {
          gif.addFrame(ctx, { copy: true, delay: 1000 / fps });
        } catch (e) {
          console.error('프레임 추가 에러:', e);
        }
        frame++;
        if (frame < totalFrames) {
          requestAnimationFrame(captureFrame);
        } else {
          gif.render();
        }
      }

      gif.on('finished', function (blob) {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${audioFileName}_비주얼.gif`;
        link.click();
      });

      captureFrame();
    });
  </script>
<!-- git add index.html -->
 <!-- git commit -m "index.html update" -->
  <!-- git push origin main -->
</body>
</html>
