<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Music Notes Animator</title>
<style>
body { display:flex; flex-direction:column; align-items:center; justify-content:flex-start; min-height:100vh; background:#111; color:#fff; font-family:Arial, sans-serif; margin:0; padding:20px; }
#controls { display:flex; flex-wrap:wrap; gap:15px; margin-bottom:20px; }
#controls label { display:flex; flex-direction:column; font-size:14px; }
canvas { background:transparent; display:block; border:1px solid #444; }
button { padding:8px 15px; font-size:14px; cursor:pointer; }
</style>
</head>
<body>

<div id="controls">
    <label>음표 색상: <input type="color" id="noteColor" value="#ff00ff"></label>
    <label>최소 음표 수: <input type="number" id="minNotes" value="3" min="1" max="10"></label>
    <label>최대 음표 수: <input type="number" id="maxNotes" value="7" min="1" max="10"></label>
    <label>캔버스 가로: <input type="number" id="canvasWidth" value="800" min="100"></label>
    <label>캔버스 세로: <input type="number" id="canvasHeight" value="200" min="50"></label>
    <label>속도: <input type="number" id="speed" value="2" min="1" max="20"></label>
    <label>랜덤 음표: <input type="checkbox" id="randomNotes" checked></label>
    <label>음표 선택 (쉼표로 구분): <input type="text" id="customNotes" value="♫,♪,♬,♩,♭"></label>
    <button id="saveGifBtn">GIF 저장</button>
</div>

<canvas id="musicCanvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/gif.js.optimized/dist/gif.js"></script>
<script>
const canvas = document.getElementById('musicCanvas');
const ctx = canvas.getContext('2d', { willReadFrequently: true });

let config = {
    color:'#ff00ff',
    canvasWidth:800,
    canvasHeight:200,
    minNotes:3,
    maxNotes:7,
    speed:2,
    randomNotes:true,
    customNotes:['♫','♪','♬','♩','♭']
};

let notesString = '';
let x = -50;
let fontSize = config.canvasHeight*0.6;

// GUI에서 설정값 읽기
function updateConfigFromGUI() {
    config.color = document.getElementById('noteColor').value;
    config.minNotes = parseInt(document.getElementById('minNotes').value);
    config.maxNotes = parseInt(document.getElementById('maxNotes').value);
    config.canvasWidth = parseInt(document.getElementById('canvasWidth').value);
    config.canvasHeight = parseInt(document.getElementById('canvasHeight').value);
    config.speed = parseFloat(document.getElementById('speed').value);
    config.randomNotes = document.getElementById('randomNotes').checked;
    config.customNotes = document.getElementById('customNotes').value.split(',').map(s=>s.trim()).filter(s=>s);

    canvas.width = config.canvasWidth;
    canvas.height = config.canvasHeight;
    fontSize = config.canvasHeight*0.6;
}

// 음표 문자열 생성
function generateNotes() {
    const count = Math.floor(Math.random()*(config.maxNotes - config.minNotes +1)) + config.minNotes;
    let notes = [];
    for(let i=0;i<count;i++){
        if(config.randomNotes){
            const randIndex = Math.floor(Math.random()*config.customNotes.length);
            notes.push(config.customNotes[randIndex]);
        } else {
            notes.push(config.customNotes[i%config.customNotes.length]);
        }
    }
    return notes.join('');
}

// 애니메이션
function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.font = `${fontSize}px Arial`;
    ctx.fillStyle = config.color;
    
    for(let i=0;i<notesString.length;i++){
        let char = notesString[i];
        let charX = x + i*fontSize*0.8;
        let charY = canvas.height/2 + Math.sin((x+i*20)/20)*20;
        ctx.fillText(char,charX,charY);
    }

    x += config.speed;
    if(x > canvas.width + 50){
        x = -50;
        notesString = generateNotes();
    }

    requestAnimationFrame(draw);
}

// 초기 설정
updateConfigFromGUI();
notesString = generateNotes();
draw();

// GUI 이벤트
document.getElementById('noteColor').addEventListener('input', ()=>{ config.color=document.getElementById('noteColor').value });
['minNotes','maxNotes','canvasWidth','canvasHeight','speed','randomNotes','customNotes'].forEach(id=>{
    document.getElementById(id).addEventListener('change', ()=>{
        updateConfigFromGUI();
        notesString = generateNotes();
    });
});

// GIF 저장
document.getElementById('saveGifBtn').addEventListener('click', ()=>{
    const gif = new GIF({workers:2, quality:10, width:config.canvasWidth, height:config.canvasHeight});
    let tempX = x;
    for(let i=0;i<50;i++){ // 프레임 수
        ctx.clearRect(0,0,canvas.width,canvas.height);
        for(let j=0;j<notesString.length;j++){
            let charX = tempX + j*fontSize*0.8;
            let charY = canvas.height/2 + Math.sin((tempX+j*20)/20)*20;
            ctx.fillText(notesString[j], charX, charY);
        }
        gif.addFrame(ctx,{copy:true,delay:50});
        tempX += config.speed; // 속도 반영
    }
    gif.on('finished', function(blob){
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'music_notes.gif';
        a.click();
    });
    gif.render();
});
</script>

</body>
</html>
